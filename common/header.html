<script type="text/discourse-plugin" version="0.8">
    const { registerUnbound } = require("discourse-common/lib/helpers");
    const headerAddonRoutes = [
      'topic.fromParams',
      'topic.fromParamsNear',
      'group.index',
      'group.activity.posts',
      'group.activity.topics',
      'group.activity.mentions',
      'group.messages.inbox',
      'group.manage.profile',
      'group.categories',
      'group.topics',
      'discovery.parentCategory',
      'discovery.latestParentCategory',
      'discovery.parentCategory',
      'discovery.unreadParentCategory',
      'discovery.newParentCategory',
      'discovery.topParentCategory',
      'discovery.category',
      'discovery.categoryNone'
    ]
    const container = Discourse.__container__;
    const route = container.lookup("route:application");
    let groupNames = []

    function isGroupRoute () {
      return route.controller.currentRouteName.indexOf('group.') === 0
    }

    function isDiscoveryRoute () {
      return route.controller.currentRouteName.indexOf('discovery.') === 0
    }

    function isTopicRoute () {
      return route.controller.currentRouteName.indexOf('topic.') === 0
    }

    function filterNames (value, index, self) {
      if(value !== false || value !== null || value !== 0 || value !== "" || self.indexOf(value) === index) {
        return value
      }
    }

    function currentProjectNames() {
      let gn = []
      switch (true) {
        case isGroupRoute():
          gn.push(route.controllerFor('group').get('model.name'))
          break;
        case isTopicRoute():
          gn = gn.concat(route.controllerFor('topic').get('model.category.group_names') || [])
          break;
        case isDiscoveryRoute():
          gn = gn.concat(route.controllerFor('discovery').get('category.group_names') || [])
          break;
      }
      // Return unique and non-nul values
      return gn.filter(filterNames)
    }

    function icijProjectsNames () {
      const ctrl = container.lookup("site:main")
      return ctrl.get('icij_group_names') || ctrl.get('icij_project_names') || []
    }

    function icijProjectLinkHTML (category, className = '') {
      return new Handlebars.SafeString(category.group_names.map(group_name => {
        // Only create link for ICIJ groups
        if ( icijProjectsNames().indexOf(group_name) > -1 ) {
          const href = Discourse.getURL(`/groups/${group_name.toLowerCase()}/categories`)
          return `<a href="${href}" class="category-project-addon category-project-addon-link ${className}">${group_name}</a>`;
        }
      }).join(' '));
    }

    // This will add a topic addon next to the home-logo, in the navbar
    // ****************************************************************
    api.decorateWidget("home-logo:after", helper => {

      helper.widget.appEvents.on('page:changed', ({ currentRouteName }) => {
        groupNames = headerAddonRoutes.indexOf(currentRouteName) > -1 ? currentProjectNames() : []
        helper.widget.scheduleRerender()
      });

      const items = _.map(groupNames, group_name => {
        const href = `/groups/${group_name.toLowerCase()}/categories`
        return helper.h('a.header-projects-item', { href }, group_name)
      });

      return helper.h('div.header-projects', items[0])
    });

    // This will add a topic addon next to a category link, in the category drop
    // *************************************************************************
    registerUnbound("category-project-addon", function(category, link = false) {
        return new Handlebars.SafeString(category.group_names.map(group_name => {
          // Only create link for ICIJ groups
          if ( icijProjectsNames().indexOf(group_name) > -1 ) {
            return `<span class="category-project-addon">${group_name}</span>`;
          }
        }).join(' '));
    });

    // This will create a link to a project
    // ************************************
    registerUnbound("category-project-addon-link", function(category) {
      return icijProjectLinkHTML(category);
    });

    // This will create a link to a project only if we're not in the group route
    // *************************************************************************
    registerUnbound("category-title-before-project-addon", function(category) {
      // Skip if it's a child group
      return isGroupRoute() || !!category.parentCategory ? '' :  icijProjectLinkHTML(category, 'category-title-before-project-addon');
    });

    // This will add a topic addon next to a topic link, in "latest"
    // *************************************************************
    registerUnbound("topic-list-item-project-addon", function(topic) {
      return !topic.category ? '' : icijProjectLinkHTML(topic.category, 'topic-list-item-project-addon');
    });
</script>

<script type='text/x-handlebars' data-template-name='/connectors/category-title-before/project-addon'>
  {{category-title-before-project-addon category}}
</script>

<script type='text/x-handlebars' data-template-name='select-kit/templates/components/category-row'>
  {{#if category}}
      {{#if hasParentCategory}}
        <div class="category-status">
          {{category-project-addon category}}
          {{#unless hideParentCategory}}
            {{badgeForParentCategory}}
          {{/unless}}
          {{badgeForCategory}}
          <span class="topic-count">{{topicCount}}</span>
        </div>
      {{else}}
        <div class="category-status">
          {{category-project-addon category}}
          {{badgeForCategory}}
          <span class="topic-count">{{topicCount}}</span>
        </div>
      {{/if}}

      {{#if shouldDisplayDescription}}
        <div class="category-desc">{{{dir-span description}}}</div>
      {{/if}}
  {{else}}
    {{{label}}}
  {{/if}}
</script>

<script type='text/x-handlebars' data-template-name='list/topic-list-item.raw'>
  {{#if bulkSelectEnabled}}
    <td class="bulk-select">
      <input type="checkbox" class="bulk-select">
    </td>
  {{/if}}

  {{!--
    The `~` syntax strip spaces between the elements, making it produce
    `<a class=topic-post-badges>Some text</a><span class=topic-post-badges>`,
    with no space between them.
    This causes the topic-post-badge to be considered the same word as "text"
    at the end of the link, preventing it from line wrapping onto its own line.
  --}}
  <td class='main-link clearfix' colspan="{{titleColSpan}}">
    {{topic-list-item-project-addon topic}}

    <span class='link-top-line'>
      {{~raw-plugin-outlet name="topic-list-before-status"}}
      {{~raw "topic-status" topic=topic}}
      {{~topic-link topic class="raw-link raw-topic-link"}}
      {{~#if topic.featured_link}}
        {{~topic-featured-link topic}}
      {{~/if}}
      {{~raw-plugin-outlet name="topic-list-after-title"}}
      {{~#if showTopicPostBadges}}
        {{~raw "topic-post-badges" unread=topic.unread newPosts=topic.displayNewPosts unseen=topic.unseen url=topic.lastUnreadUrl newDotText=newDotText}}
      {{~/if}}
    </span>

    {{discourse-tags topic mode="list" tagsForUser=tagsForUser}}
    {{#if expandPinned}}
      {{raw "list/topic-excerpt" topic=topic}}
    {{/if}}
    {{raw "list/action-list" topic=topic postNumbers=topic.liked_post_numbers className="likes" icon="heart"}}
  </td>

  {{#unless hideCategory}}
    {{#unless topic.isPinnedUncategorized}}
      {{raw "list/category-column" category=topic.category}}
    {{/unless}}
  {{/unless}}

  {{#if showPosters}}
    {{raw "list/posters-column" posters=topic.posters}}
  {{/if}}

  {{raw "list/posts-count-column" topic=topic}}

  {{#if showParticipants}}
    {{raw "list/posters-column" posters=topic.participants}}
  {{/if}}

  {{#if showLikes}}
  <td class="num likes">
    {{#if hasLikes}}
      <a href='{{topic.summaryUrl}}'>
        {{number topic.like_count}} {{d-icon "heart"}}</td>
      </a>
    {{/if}}
  {{/if}}

  {{#if showOpLikes}}
  <td class="num likes">
    {{#if hasOpLikes}}
      <a href='{{topic.summaryUrl}}'>
        {{number topic.op_like_count}} {{d-icon "heart"}}</td>
      </a>
    {{/if}}
  {{/if}}

  <td class="num views {{topic.viewsHeat}}">{{number topic.views numberKey="views_long"}}</td>

  {{raw "list/activity-column" topic=topic class="num" tagName="td"}}
</script>
